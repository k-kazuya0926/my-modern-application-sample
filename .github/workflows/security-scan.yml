name: Security Scan with Trivy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # æ¯Žæ—¥21æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: "0 21 * * *"

defaults: # ãƒ‘ã‚¤ãƒ—ã‚¨ãƒ©ãƒ¼ã‚’æ‹¾ãˆã‚‹ã‚ˆã†ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã‚’è¨­å®š
  run:
    shell: bash

concurrency: # ã‚³ãƒŸãƒƒãƒˆè¿½åŠ æ™‚ã«å¤ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trivy-secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³ã«ã¯å…¨å±¥æ­´ãŒå¿…è¦

      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "secret"
          format: "sarif"
          output: "trivy-secret-results.sarif"
          trivy-config: "trivy.yaml"

      - name: Upload Trivy secret scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-secret-results.sarif"

  trivy-vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "vuln"
          format: "sarif"
          output: "trivy-vuln-results.sarif"
          trivy-config: "trivy.yaml"

      - name: Upload Trivy vulnerability scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-vuln-results.sarif"

      - name: Run Trivy vulnerability scanner for summary
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "vuln"
          format: "table"
          trivy-config: "trivy.yaml"

  trivy-config-scan:
    name: Configuration Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "."
          format: "sarif"
          output: "trivy-config-results.sarif"
          trivy-config: "trivy.yaml"

      - name: Upload Trivy config scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-config-results.sarif"

      - name: Run Trivy config scanner for summary
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "."
          format: "table"
          trivy-config: "trivy.yaml"

  trivy-docker-scan:
    name: Docker Image Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          cd lambda/hello-world
          docker build -t hello-world:latest .

      - name: Run Trivy vulnerability scanner on Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "hello-world:latest"
          format: "sarif"
          output: "trivy-docker-results.sarif"

      - name: Upload Trivy Docker scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-docker-results.sarif"

      - name: Run Trivy vulnerability scanner on Docker image for summary
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "hello-world:latest"
          format: "table"

  trivy-license-scan:
    name: License Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy license scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "license"
          format: "table"
          output: "trivy-license-results.txt"

      - name: Display license scan results
        if: always()
        run: |
          echo "## License Scan Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-license-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        trivy-secret-scan,
        trivy-vulnerability-scan,
        trivy-config-scan,
        trivy-license-scan,
      ]
    if: always()
    steps:
      - name: Security scan summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.trivy-secret-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vulnerability Scan | ${{ needs.trivy-vulnerability-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration Scan | ${{ needs.trivy-config-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Scan | ${{ needs.trivy-license-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ãªçµæžœã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã¨GitHub Security ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
